---
import ModalDesign from "./ModalDesign.astro";
---

<ModalDesign id="modal-invited-person">
  <article class="flex flex-col gap-6">
    <header class="border-b border-neutral-300">
      <h2>Invitar hermanos</h2>
    </header>
    <div class="body">
      <!-- Nueva búsqueda -->
      <div class="search content-input">
        <input
          type="text"
          placeholder=" "
          class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="search-invited-person"
        />
        <label for="search-invited-person" class="label-text">
          Buscar por nombre
        </label>
      </div>

      <!-- Resultados de búsqueda -->
      <div
        id="search-results"
        class="mt-4 border border-gray-300 rounded-md p-4 hidden max-h-64 overflow-y-auto"
      >
        <div id="results-list" class="space-y-2">
          <!-- Los resultados se llenarán aquí -->
        </div>
      </div>

      <!-- Lista de invitados seleccionados -->
      <div id="invited-list" class="mt-4 hidden">
        <h3 class="text-sm font-semibold mb-3 text-gray-700">Más invitados</h3>
        <div
          id="selected-invites"
          class="space-y-2 border border-gray-300 rounded-md p-3 max-h-48 overflow-y-auto bg-blue-50"
        >
          <!-- Los invitados seleccionados se mostrarán aquí -->
        </div>
      </div>
    </div>
    <footer class="flex items-center gap-2">
      <button class="btn btn-secondary w-full" id="close-invite-person">
        Cerrar
      </button>
      <button
        class="btn btn-primary w-full"
        id="confirm-invite-person"
        disabled
      >
        Invitar
      </button>
    </footer>
  </article>
</ModalDesign>

<script>
  import { actions } from "astro:actions";
  import { $id } from "@/utils/getElements";

  interface SearchResult {
    group_id: string;
    person_id: number;
    marriage_id: number | null;
    names: string;
    civil_status: string;
    community_id: number;
    number_community: number;
    parroquia: string;
    phone: string | null;
  }

  interface SelectedInvite {
    group_id: string;
    person_id: number;
    marriage_id: number | null;
    names: string;
    civil_status: string;
    number_community: number;
    parroquia: string;
  }

  document.addEventListener("astro:page-load", () => {
    const modal = $id("modal-invited-person") as HTMLElement;
    const searchInput = $id("search-invited-person") as HTMLInputElement;
    const confirmButton = $id("confirm-invite-person") as HTMLButtonElement;
    const closeButton = $id("close-invite-person") as HTMLButtonElement;
    const searchResults = $id("search-results") as HTMLElement;
    const resultsList = $id("results-list") as HTMLElement;
    const invitedList = $id("invited-list") as HTMLElement;
    const selectedInvites = $id("selected-invites") as HTMLElement;

    let retreatIdSelected = 0;
    let selectedInvitesData: SelectedInvite[] = [];

    // Función para abrir la modal
    function openModal(retreatId: number) {
      retreatIdSelected = retreatId;
      modal.classList.add("show");
      searchInput.value = "";
      resetSelections();
      console.log(`Modal abierta para convivencia ${retreatId}`);
    }

    function closeModal() {
      modal.classList.remove("show");
      searchInput.value = "";
      retreatIdSelected = 0;
      resetSelections();
    }

    function resetSelections() {
      selectedInvitesData = [];
      searchResults.classList.add("hidden");
      invitedList.classList.add("hidden");
      resultsList.innerHTML = "";
      selectedInvites.innerHTML = "";
      confirmButton.disabled = true;
    }

    // Búsqueda de hermanos
    let searchTimeout: NodeJS.Timeout;
    searchInput.addEventListener("input", async (e) => {
      clearTimeout(searchTimeout);
      const searchValue = (e.target as HTMLInputElement).value.trim();

      if (searchValue.length < 2) {
        searchResults.classList.add("hidden");
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const { data, error } = await actions.searchBrothers({
            name: searchValue,
            retreat_id: retreatIdSelected,
          });
          if (!error && data?.success && data?.data) {
            displaySearchResults(data.data as SearchResult[]);
            searchResults.classList.remove("hidden");
          }
        } catch (err) {
          console.error("Error en búsqueda:", err);
        }
      }, 300);
    });

    function displaySearchResults(results: SearchResult[]) {
      resultsList.innerHTML = "";

      if (results.length === 0) {
        resultsList.innerHTML =
          '<div class="text-gray-500 text-sm">No se encontraron resultados</div>';
        return;
      }

      results.forEach((result) => {
        const resultItem = document.createElement("div");
        resultItem.className =
          "flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer";

        const isSelected = selectedInvitesData.some(
          (item) => item.group_id === result.group_id,
        );

        resultItem.innerHTML = `
          <input 
            type="checkbox" 
            class="result-checkbox w-4 h-4 cursor-pointer" 
            data-group-id="${result.group_id}"
            data-person-id="${result.person_id}"
            data-marriage-id="${result.marriage_id || ""}"
            data-names="${result.names}"
            data-civil-status="${result.civil_status}"
            data-number-community="${result.number_community}"
            data-parroquia="${result.parroquia}"
            ${isSelected ? "checked" : ""}
          />
          <div class="flex-1">
            <div class="font-medium text-sm">${result.names}</div>
            <div class="text-xs text-gray-600">
              Comunidad: ${result.number_community} | 
              Parroquia: ${result.parroquia} | 
              Estado civil: ${result.civil_status}
            </div>
          </div>
        `;

        const checkbox = resultItem.querySelector(
          ".result-checkbox",
        ) as HTMLInputElement;
        checkbox.addEventListener("change", (e) => {
          const isChecked = (e.target as HTMLInputElement).checked;
          if (isChecked) {
            addToSelected(result);
          } else {
            removeFromSelected(result.group_id);
          }
        });

        resultsList.appendChild(resultItem);
      });
    }

    function addToSelected(result: SearchResult) {
      const alreadySelected = selectedInvitesData.some(
        (item) => item.group_id === result.group_id,
      );
      if (!alreadySelected) {
        selectedInvitesData.push({
          group_id: result.group_id,
          person_id: result.person_id,
          marriage_id: result.marriage_id,
          names: result.names,
          civil_status: result.civil_status,
          number_community: result.number_community,
          parroquia: result.parroquia,
        });
        updateSelectedInvitesList();
        updateConfirmButton();
      }
    }

    function removeFromSelected(groupId: string) {
      selectedInvitesData = selectedInvitesData.filter(
        (item) => item.group_id !== groupId,
      );
      updateSelectedInvitesList();
      updateConfirmButton();

      // Desmarcar checkbox
      const checkbox = document.querySelector(
        `[data-group-id="${groupId}"]`,
      ) as HTMLInputElement;
      if (checkbox) checkbox.checked = false;
    }

    function updateSelectedInvitesList() {
      if (selectedInvitesData.length === 0) {
        invitedList.classList.add("hidden");
        selectedInvites.innerHTML = "";
        return;
      }

      invitedList.classList.remove("hidden");
      selectedInvites.innerHTML = "";

      selectedInvitesData.forEach((invite) => {
        const inviteItem = document.createElement("div");
        inviteItem.className =
          "flex items-center justify-between gap-2 p-2 bg-white rounded border border-blue-200";

        inviteItem.innerHTML = `
          <div class="flex-1 text-sm">
            <div class="font-medium">${invite.names}</div>
            <div class="text-xs text-gray-600">
              Com. ${invite.number_community} | ${invite.parroquia} | ${invite.civil_status}
            </div>
          </div>
          <button 
            class="remove-invite text-red-500 hover:text-red-700 font-semibold"
            data-group-id="${invite.group_id}"
          >
            ✕
          </button>
        `;

        const removeBtn = inviteItem.querySelector(".remove-invite");
        if (removeBtn) {
          removeBtn.addEventListener("click", () => {
            removeFromSelected(invite.group_id);
          });
        }

        selectedInvites.appendChild(inviteItem);
      });
    }

    function updateConfirmButton() {
      confirmButton.disabled = selectedInvitesData.length === 0;
    }

    closeButton.addEventListener("click", closeModal);

    confirmButton.addEventListener("click", () => {
      if (selectedInvitesData.length === 0) {
        alert("Por favor selecciona al menos una persona para invitar");
        return;
      }
      console.log(
        `Invitando ${selectedInvitesData.length} personas a convivencia ${retreatIdSelected}`,
        selectedInvitesData,
      );

      // Emitir evento con los invitados seleccionados
      window.dispatchEvent(
        new CustomEvent("retreat:new-invites", {
          detail: {
            retreat_id: retreatIdSelected,
            invites: selectedInvitesData,
          },
        }),
      );

      // Cerrar modal después de invitar
      closeModal();
    });

    (window as any).openModalInvited = openModal;
  });
</script>

<style>
  #search-results:not(.hidden) {
    display: block;
  }
</style>
