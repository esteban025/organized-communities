---
import { IfCatechistInput } from "@/components/react/IfCatechistInput";
import CivilIndicator from "@/components/CivilIndicator.astro";
import RolesBrotherChecks from "@/components/RolesBrotherChecks.astro";
import { actions } from "astro:actions";
const { communityId } = Astro.props;
---

<section
  class="card-section h-min sticky top-6"
  transition:name="section-form"
  style="grid-area: form;"
>
  <form
    action={actions.postBrother}
    id="form-brother"
    class="design-form space-y-4"
  >
    <!-- servira para edicion de una persona -->
    <input id="brother-id" type="hidden" name="brother-id" value="" />
    <input
      id="community-id"
      type="hidden"
      name="community-id"
      value={communityId}
    />

    <fieldset class="space-y-2">
      <legend>Datos personales</legend>
      <!-- estado civil -->
      <div class="container-civil-status mb-5">
        <div class="wrapper" id="wrapper-civil-status">
          <div
            class="ratios-row flex items-center rounded-full bg-neutral-100 border-2 border-neutral-300 relative"
          >
            <div class="content-c-s">
              <input
                type="radio"
                name="civil-status"
                id="ratio-matrimonio"
                value="matrimonio"
                class="checks-civil"
                data-index="0"
              />
              <label for="ratio-matrimonio" class="radio-label"
                >Matrimonio</label
              >
            </div>
            <div class="content-c-s">
              <input
                type="radio"
                name="civil-status"
                id="ratio-soltero"
                value="soltero"
                class="checks-civil"
                checked
                data-index="1"
              />
              <label for="ratio-soltero" class="radio-label">Soltero</label>
            </div>
            <div class="content-c-s">
              <input
                type="radio"
                name="civil-status"
                id="ratio-soltera"
                class="checks-civil"
                value="soltera"
                data-index="2"
              />
              <label for="ratio-soltera" class="radio-label">Soltera</label>
            </div>

            <!-- indicador personalizado -->
            <CivilIndicator />
          </div>
        </div>
      </div>

      <!-- nombres -->
      <!-- si es matrimonio renderizamos uno -->
      <div class="container-info-married mb-1 animate-entry">
        <div class="flex flex-col gap-4">
          <div class="content-data-husband flex items-center gap-2">
            <div class="content-input">
              <input
                type="text"
                name="names-husband"
                id="names-husband"
                autocomplete="off"
                placeholder=" "
              />
              <label for="names-husband" class="label-text"
                >Nombres - Esposo</label
              >
            </div>
            <div class="content-input">
              <input
                type="tel"
                name="phone-husband"
                id="phone-husband"
                autocomplete="off"
                placeholder=" "
              />
              <label for="phone-husband" class="label-text">Celular</label>
            </div>
          </div>
          <div class="content-data-wife flex items-center gap-2">
            <div class="content-input">
              <input
                type="text"
                name="names-wife"
                id="names-wife"
                autocomplete="off"
                placeholder=" "
              />
              <label for="names-wife" class="label-text">Nombres - Esposa</label
              >
            </div>
            <div class="content-input">
              <input
                type="tel"
                name="phone-wife"
                id="phone-wife"
                autocomplete="off"
                placeholder=" "
              />
              <label for="phone-wife" class="label-text">Celular</label>
            </div>
          </div>
        </div>
      </div>
      <!-- si no es matrimonio renderizamos otro -->
      <div class="container-info-single mb-1 animate-entry">
        <div class="flex flex-col gap-4">
          <div class="content-input">
            <input
              type="text"
              name="name-bro"
              id="name-bro"
              autocomplete="off"
              placeholder=" "
            />
            <label for="name-bro" class="label-text">Nombre Completo</label>
          </div>
          <div class="content-input">
            <input
              type="tel"
              name="phone-bro"
              id="phone-bro"
              autocomplete="off"
              placeholder=" "
            />
            <label for="phone-bro" class="label-text">Celular</label>
          </div>
        </div>
      </div>
      <!-- roles -->
    </fieldset>

    <!-- roles -->
    <fieldset class="fieldset-roles">
      <legend>Roles en Comunidad</legend>
      <RolesBrotherChecks />
    </fieldset>

    <!-- si es catequista -->
    <fieldset class="fieldset-catequistas animate-entry">
      <legend>Catequistas</legend>
      <IfCatechistInput client:load />
    </fieldset>

    <div class="content-actions">
      <button type="reset" class="btn btn-secondary w-full">Resetear</button>
      <button type="submit" class="btn btn-primary w-full">Agregar</button>
    </div>
  </form>
</section>

<style>
  .content-c-s {
    position: relative;
    z-index: 10;
    width: 100%;

    & .radio-label {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0.4rem 0;
      transition: font-weight 200ms ease;
    }

    & input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    &:has(input:checked) .radio-label {
      font-weight: 600;
    }
  }

  /* dinamic input names */
  .container-civil-status:has(input[value="matrimonio"]:checked) {
    & ~ .container-info-married {
      display: block;
    }
    & ~ .container-info-single {
      display: none;
    }
  }

  .container-civil-status:has(input[value="soltero"]:checked),
  .container-civil-status:has(input[value="soltera"]:checked) {
    & ~ .container-info-married {
      display: none;
    }
    & ~ .container-info-single {
      display: block;
    }
  }

  /* dinamic input select roles */
  .fieldset-catequistas {
    display: none;
  }

  .fieldset-roles:has(input[value="catequista"]:checked) {
    & ~ .fieldset-catequistas {
      display: block;
    }
  }

  .only-read {
    opacity: 0.45;
    pointer-events: none;

    & input {
      cursor: not-allowed;
    }
  }
</style>

<script>
  import { showNotification } from "@/scripts/notification";
  import { warningMessage } from "@/scripts/warning-message";
  import { $, $$, $id } from "@/utils/getElements";
  import type { BrotherOutDB } from "@/types/brothers";
  import { actions } from "astro:actions";

  document.addEventListener("astro:page-load", () => {
    const form = $id("form-brother") as HTMLFormElement;
    const brotherId = $id("brother-id") as HTMLInputElement;
    const containerCS = $(".container-civil-status") as HTMLDivElement;
    const checkCivil = $$(".checks-civil") as NodeListOf<HTMLInputElement>;
    const rolesPrincipals = $$(
      ".roles-principals",
    ) as NodeListOf<HTMLInputElement>;
    const rolesSupport = $$(".roles-support") as NodeListOf<HTMLInputElement>;

    // single
    const nameBro = $id("name-bro") as HTMLInputElement;
    const phoneBro = $id("phone-bro") as HTMLInputElement;

    // married
    const containerHusband = $(".content-data-husband") as HTMLDivElement;
    const containerWife = $(".content-data-wife") as HTMLDivElement;
    const husbandName = $id("names-husband") as HTMLInputElement;
    const husbandPhone = $id("phone-husband") as HTMLInputElement;
    const wifeName = $id("names-wife") as HTMLInputElement;
    const wifePhone = $id("phone-wife") as HTMLInputElement;

    // funcion para rellenar los roles
    function fillRoles(listRoles: string[], listRolesSec: number[]) {
      // Roles
      const roles = Array.isArray(listRoles) ? [...listRoles] : [];
      const rolesSec = Array.isArray(listRolesSec) ? [...listRolesSec] : [];

      // Si tiene comunidades de catequista, marcamos también el rol "catequista"
      if (rolesSec.length > 0 && !roles.includes("catequista")) {
        roles.push("catequista");
      }

      const principalRole =
        roles.find((r) => r === "responsable" || r === "corresponsable") || "";
      const hasSecondaryRole = roles.some(
        (r) => r !== "responsable" && r !== "corresponsable",
      );

      // Regla: si tiene algún rol (principal o secundario), "Ninguno" NO puede estar seleccionado
      rolesPrincipals.forEach((input) => {
        const isNone = input.id === "role-none";

        if (!principalRole && !hasSecondaryRole) {
          // Sin ningún rol asignado: solo "Ninguno" marcado
          input.checked = isNone;
          return;
        }

        if (principalRole) {
          // Hay rol principal: marcamos solo ese
          input.checked = input.value === principalRole;
          return;
        }

        // Hay roles secundarios pero ningún principal: ningún principal marcado (tampoco "Ninguno")
        input.checked = false;
      });

      rolesSupport.forEach((input) => {
        input.checked = false;
      });

      roles
        .filter((r) => r !== "responsable" && r !== "corresponsable")
        .forEach((role) => {
          const checkbox = form.querySelector<HTMLInputElement>(
            `input[name="roles-support"][value="${role}"]`,
          );
          if (checkbox) {
            checkbox.checked = true;
          }
        });

      if (rolesSec.length > 0) {
        // marcar las comunidades de catequista
        window.dispatchEvent(
          new CustomEvent("brother:edit", {
            detail: {
              catechistCommunityIds: rolesSec,
            },
          }),
        );
      }
    }

    // === ELIMINAR HERMANOS ===
    async function handleDeleteBrother(ids: number[]) {
      const confirmAction = await warningMessage(
        "Eliminar Hermano/as",
        "¿Estás seguro de que deseas continuar con este paso? Recuerda en el caso de ser matrimonio se eliminarán ambos registros.",
      );

      if (!confirmAction) return;

      try {
        const { data, error } = await actions.deleteBrother({ ids });
        if (error || !data?.success) {
          showNotification(
            data?.message || error?.message || "Error al eliminar al hermano",
            "error",
          );
          return;
        }
        showNotification(data.message, "success");
        window.dispatchEvent(new Event("brothers:updated"));
      } catch (err) {
        console.error("Error eliminando hermano:", err);
        showNotification("Error al eliminar al hermano", "error");
      }
    }

    // === EDITAR HERMANO/A ===
    async function handleEditBrother(id: number) {
      window.scrollTo({ top: 0, behavior: "smooth" });
      form.reset();
      try {
        const { data, error } = await actions.getBrotherById({ id });
        if (error || !data?.success || !data.data) {
          showNotification(
            data?.message ||
              error?.message ||
              "Error al obtener datos del hermano",
            "error",
          );
          return;
        }

        const brother = data.data as BrotherOutDB;
        console.log(brother);

        // === ACTUALIZAR MATRIMONIO ===
        if (brother.civil_status === "matrimonio") {
          brotherId.value = String(brother.id);

          checkCivil.forEach((input) => {
            input.checked = input.value === "matrimonio";
            (window as any).updateCivilIndicator();
          });
          containerCS.classList.add("only-read");

          const { marriage_id, spouse_id, spouse_name } = brother;

          if (!marriage_id || !spouse_id || !spouse_name) {
            showNotification("Error: Datos de matrimonio incompletos", "error");
            return;
          }

          if (brother.id < spouse_id) {
            husbandName.value = brother.names || "";
            husbandPhone.value = brother.phone ?? "";
            wifeName.value = brother.spouse_name || "";
            wifePhone.value = brother.spouse_phone ?? "";
            containerWife.classList.add("only-read");
            containerHusband.classList.remove("only-read");

            // Esposo
          } else {
            // Esposa
            husbandName.value = brother.spouse_name || "";
            husbandPhone.value = brother.spouse_phone ?? "";
            wifeName.value = brother.names || "";
            wifePhone.value = brother.phone ?? "";
            containerHusband.classList.add("only-read");
            containerWife.classList.remove("only-read");
          }

          fillRoles(brother.roles, brother.catechist_communities);

          return;
        }

        // === ACTUALIZAR SOLTERO/A ===
        brotherId.value = String(brother.id);
        checkCivil.forEach((input) => {
          input.checked = input.value === brother.civil_status;
          (window as any).updateCivilIndicator();
        });
        containerCS.classList.add("only-read");
        nameBro.value = brother.names || "";
        phoneBro.value = brother.phone ?? "";

        // Roles
        fillRoles(brother.roles, brother.catechist_communities);

        showNotification(
          "Editando hermano. Modifica los datos y guarda.",
          "info",
        );
      } catch (error) {
        console.error("Error obteniendo datos del hermano:", error);
        showNotification("Error al obtener datos del hermano", "error");
      }
    }

    // form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const civilStatus = formData.get("civil-status") as string;
      const communityId = formData.get("community-id") as string;

      const rolesPrincipales = formData.get("roles-principals") as string;
      const rolesSupport = formData
        .getAll("roles-support")
        .filter(Boolean) as string[];
      const roles: string[] = [];

      if (rolesPrincipales && rolesPrincipales !== "") {
        roles.push(rolesPrincipales);
      }
      rolesSupport.forEach((role) => roles.push(role));

      const catechistCommunities = formData
        .getAll("catechist-community-ids")
        .map((id) => Number(id));

      // verificar que si selecciona que es catequista y no ingresa comunidades devolvemos mensaje de que se debe ingresar al menos una
      if (roles.includes("catequista") && catechistCommunities.length === 0) {
        showNotification(
          "Debes ingresar al menos una comunidad de la que eres catequista",
          "error",
        );
        return;
      }

      try {
        //  === LOGICA PARA MATRIMONIO ===
        if (civilStatus === "matrimonio") {
          const brotherId = formData.get("brother-id") as string | null;
          const husbandNames = formData.get("names-husband") as string;
          const husbandPhone = formData.get("phone-husband") as string;
          const wifeNames = formData.get("names-wife") as string;
          const wifePhone = formData.get("phone-wife") as string;

          const payloadBase = {
            kind: "marriage" as const,
            husband: {
              names: husbandNames,
              phone: husbandPhone || null,
            },
            wife: {
              names: wifeNames,
              phone: wifePhone || null,
            },
            community_id: Number(communityId),
            roles,
            catechist_communities: catechistCommunities,
          };

          const payloadMarriage =
            brotherId && brotherId !== ""
              ? {
                  ...payloadBase,
                  ...(Number(brotherId) ? { id: Number(brotherId) } : {}),
                }
              : payloadBase;

          const { data, error } = await actions.postBrother(payloadMarriage);

          if (error || !data?.success) {
            showNotification(
              data?.message ||
                error?.message ||
                "Error al registrar matrimonio",
              "error",
            );
            return;
          }

          showNotification(data.message, "success");
          form.reset();
          (window as any).updateCivilIndicator();
          window.dispatchEvent(new Event("brothers:updated"));
          return;
        }

        // === LOGICA PARA HERMANO/A SOLTERO/A ===
        const brotherId = formData.get("brother-id") as string | null;
        const names = formData.get("name-bro") as string;
        const phone = formData.get("phone-bro") as string;

        const payloadBase = {
          names,
          civil_status: civilStatus as "soltero" | "soltera",
          community_id: Number(communityId),
          phone: phone || null,
          roles,
          catechist_communities: catechistCommunities,
        };

        const payloadSingle = {
          kind: "single" as const,
          ...(brotherId && brotherId !== "" ? { id: Number(brotherId) } : {}),
          ...payloadBase,
        };

        const { data, error } = await actions.postBrother(payloadSingle);

        if (error || !data?.success) {
          showNotification(
            data?.message || error?.message || "Error al registrar hermano",
            "error",
          );
          return;
        }

        showNotification(data.message, "success");
        form.reset();
        (window as any).updateCivilIndicator();
        containerCS.classList.remove("only-read");
        window.dispatchEvent(new Event("brothers:updated"));
      } catch (err) {
        console.error("Error en el envío del formulario de hermano:", err);
        showNotification("Error en la solicitud", "error");
      }
    });

    form.addEventListener("reset", () => {
      brotherId.value = "";
      (window as any).updateCivilIndicator();
      if (containerCS.classList.contains("only-read")) {
        containerCS.classList.remove("only-read");
      }
    });

    (window as any).editBrother = handleEditBrother;
    (window as any).deleteBrother = handleDeleteBrother;
  });
</script>
