---
import type { CommunityWithBrotherCount } from "@/types/communities";
import { FusionCommunity } from "@/components/react/FusionCommunity";
import { actions } from "astro:actions";

const { parishId, parishName } = Astro.props;

let communities: CommunityWithBrotherCount[] = [];

try {
  const res = await Astro.callAction(actions.getCommunities, {
    parishId: Number(parishId),
  });
  if (res.error || !res.data.success) {
    throw new Error(
      res.error?.message || res.data?.message || "Error al obtener comunidades",
    );
  }
  communities = res.data.data;
} catch (error) {
  console.error(`Error fetching communities for parish ${parishId}:`, error);
}
---

<section class="card-section">
  <form action="" class="design-form" id="form-fusion-community">
    <input type="hidden" name="parish-id-in-fusion" value={parishId} />
    <fieldset class="flex flex-col gap-4">
      <legend>Fusionar comunidades</legend>
      <span
        class="text-sm text-neutral-500 leading-4 text-center text-balance w-11/12 mx-auto"
        >Solamente comunidades de "{parishName}"</span
      >
      <FusionCommunity client:load parishId={parishId} />
    </fieldset>
  </form>
</section>

<script>
  import { showNotification } from "@/scripts/notification";
  import { warningMessage } from "@/scripts/warning-message";
  import { $id } from "@/utils/getElements";
  import { actions } from "astro:actions";

  document.addEventListener("astro:page-load", () => {
    // Your page load logic here
    const form = $id("form-fusion-community") as HTMLFormElement;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      // obtener todos los check seleccionados
      const selectedCommunities = formData.getAll(
        "fusion-communities",
      ) as string[];
      const parishId = formData.get("parish-id-in-fusion") as string;
      if (selectedCommunities.length < 2) {
        showNotification(
          "Selecciona al menos dos comunidades para fusionar.",
          "error",
        );
        return;
      }

      try {
        // const { data, error } = await actions.fusionCommunities({
        //   parishId: Number(parishId),
        //   communityIds: selectedCommunities.map((id) => Number(id)),
        // });
      } catch (error) {
        showNotification("Error al fusionar comunidades.", "error");
        return;
      }
      showNotification("Funcionalidad en desarrollo", "info");
    });
  });
</script>
