---
import PrintListConfirmated from "@/layouts/PrintListConfirmated.astro";
import { getRetreatConfirmedAttendeesFromDB } from "@/services/retreats";
import { ViewPrintConfirmated } from "@/components/react/ViewPrintConfirmated";
import HeaderPage from "@/sections/HeaderPage.astro";
import type { StatsConf } from "@/types/retreats";

const { id } = Astro.params;
const retreatId = Number(id);

const headTable = ["Nombres", "Estado Civil", "Observaciones", "Hospedaje"];

interface ConfirmedGroup {
  group_key: string;
  nombres_confirmados: string;
  observaciones_combinadas: string | null;
  retreat_house_id: number | null;
  retreat_house_name: string | null;
  person_ids: number[];
  marriage_id: number | null;
  civil_status: string;
}

interface CommunityData {
  numero: string;
  estadisticas: {
    total_personas: number;
    total_matrimonios: number;
    total_solteros: number;
    total_solteras: number;
  };
  confirmados: ConfirmedGroup[];
}

interface ParishData {
  parroquia: string;
  comunidades: CommunityData[];
}

interface ConvData {
  titulo: string;
  fecha_inicio: string;
  fecha_fin: string;
  costo_por_persona: number;
  status: string;
}

interface RetreatPrintData {
  convivencia: ConvData;
  estadisticas: StatsConf;
  attended_person_ids: number[];
  parroquias: ParishData[];
}

let data: RetreatPrintData | null = null;
let fetchError: string | null = null;

if (!Number.isNaN(retreatId)) {
  const res = await getRetreatConfirmedAttendeesFromDB(retreatId);
  if (res.success && res.data) {
    data = res.data as RetreatPrintData;
  } else {
    fetchError = res.message || "Error al obtener los confirmados";
  }
} else {
  fetchError = "ID de convivencia no válido";
}
---

<PrintListConfirmated
  title="Camino Neocatecumenal | Imprimir lista de confirmados"
  description="Imprime la lista de hermanos confirmados para un retiro específico."
>
  <div class="space-y-8">
    <HeaderPage
      description="Puedes imprimir lista completa de hermanos confirmados a la convivencia."
    />
    {fetchError && <p class="message-card error">{fetchError}</p>}

    {
      !fetchError && data && data.parroquias.length === 0 && (
        <p class="message-card">
          No hay hermanos confirmados para esta convivencia.
        </p>
      )
    }

    {
      !fetchError && data && data.parroquias.length > 0 && (
        <ViewPrintConfirmated
          client:load
          retreatId={retreatId}
          parroquias={data.parroquias}
          headTable={headTable}
          convivencia={data.convivencia}
          estadisticas={data.estadisticas}
          attendedPersonIds={data.attended_person_ids}
        />
      )
    }
  </div>
</PrintListConfirmated>
